# Task Files UI Documentation

## Overview

The task files UI provides a comprehensive interface for browsing and viewing files generated by pipeline tasks. Files are organized into three categories: **artifacts**, **logs**, and **tmp** (temporary files).

## Components

### DAGGrid

The main component that displays pipeline tasks with file browsing capabilities.

#### Features

- **Task Cards**: Visual representation of pipeline tasks with status indicators
- **Slide-over Panel**: Detailed view for each task including files
- **File Categories**: Tabbed interface for artifacts, logs, and temporary files
- **File Preview**: Modal interface for viewing individual file contents

#### Props

```javascript
<DAGGrid
  items={dagItems} // Array of DAG items
  cols={3} // Grid columns (responsive)
  activeIndex={2} // Currently active step
  jobId="job-123" // Job ID for file operations
  filesByTypeForItem={(item) => ({
    // File selector function
    artifacts: ["output.json", "result.txt"],
    logs: ["execution.log"],
    tmp: ["temp.dat"],
  })}
/>
```

### TaskFilePane

Modal component for displaying individual file contents with preview capabilities.

#### Features

- **Content Preview**: Supports JSON, text, markdown, and binary files
- **Copy Functionality**: Copy text content to clipboard
- **Error Handling**: Graceful handling of missing or inaccessible files
- **Metadata Display**: File size, modification time, and MIME type
- **Keyboard Navigation**: Escape key to close, proper focus management

#### Props

```javascript
<TaskFilePane
  isOpen={true} // Whether the pane is open
  jobId="job-123" // Job ID
  taskId="analysis" // Task ID
  type="artifacts" // File category (artifacts|logs|tmp)
  filename="output.json" // File name to display
  onClose={() => {}} // Close handler
/>
```

## File Categories

### Artifacts

Primary output files generated by tasks. These are typically the main results of task execution.

**Examples**: `output.json`, `result.csv`, `report.pdf`

### Logs

Execution logs and debugging information. These provide insight into task execution.

**Examples**: `execution.log`, `error.log`, `debug.txt`

### Temporary Files

Intermediate files created during task execution. These may be cleaned up automatically.

**Examples**: `temp.dat`, `cache.tmp`, `working_file.json`

## File Type Support

### Text Files

- **JSON**: Pretty-printed with syntax highlighting
- **Markdown**: Basic rendering with headers and lists
- **Plain Text**: Monospace font with line wrapping
- **Code Files**: Syntax-appropriate rendering

### Binary Files

Binary files show a "cannot be previewed" message with file type information.

**Examples**: Images, PDFs, compiled binaries

## User Interactions

### Browsing Files

1. Click on any task card to open the slide-over panel
2. Use the category tabs (Artifacts, Logs, Temp) to filter files
3. Click on any file name to open the preview modal

### File Preview

1. **View Content**: File content is displayed based on type
2. **Copy Text**: Use the Copy button for text files
3. **Close**: Use the Close button or press Escape

### Keyboard Navigation

- **Task Cards**: Tab to navigate, Enter/Space to open details
- **File Tabs**: Tab to tabs, Enter/Space to switch categories
- **File List**: Tab to file list, Enter/Space to open file
- **Modal**: Escape to close, Tab to navigate buttons

## Error Handling

### Missing Files

When a file is not found, the UI shows:

- Clear error message
- Retry button for temporary issues
- File type validation

### Invalid File Types

The system validates file types and shows appropriate error messages for:

- Invalid categories (not artifacts/logs/tmp)
- Missing file names
- Access permissions

### Network Issues

File loading failures are handled gracefully with:

- Loading indicators during fetch
- Error messages for network failures
- Retry functionality for transient issues

## Technical Implementation

### File Access

Files are accessed via the REST API:

```
GET /api/jobs/{jobId}/tasks/{taskId}/file?type={category}&filename={name}
```

### Data Flow

1. **DAGGrid** receives file data via `filesByTypeForItem` prop
2. **TaskFilePane** fetches individual file content from API
3. **Content Rendering** based on MIME type and file extension
4. **Error Boundaries** prevent component crashes

### Performance Considerations

- **Lazy Loading**: Files are only fetched when requested
- **Caching**: File content is cached during component lifecycle
- **Cleanup**: Abort controllers prevent memory leaks
- **Responsive Design**: Mobile-friendly with single-column layout

## Accessibility

### ARIA Labels

- Task cards use `role="listitem"` and `aria-current="step"`
- Modal uses `role="dialog"` and `aria-modal="true"`
- File preview uses semantic HTML structure
- Error messages use `role="alert"` and `aria-live="assertive"`

### Focus Management

- Focus returns to invoking element when closing modals
- Tab order follows logical reading order
- Keyboard navigation fully supported
- Screen reader compatible

## Styling

### Design System

- Uses Tailwind CSS for consistent styling
- Radix UI components for accessible interactions
- Responsive design with mobile-first approach
- Dark mode support where applicable

### Visual Hierarchy

- Clear distinction between file categories
- Consistent spacing and typography
- Hover states for interactive elements
- Status indicators for task states

## Integration Examples

### Basic Usage

```javascript
import { DAGGrid } from "./components/DAGGrid.jsx";
import { getFilesByTypeForTask } from "./utils/task-files.js";

function JobDetail({ job }) {
  return (
    <DAGGrid
      items={job.tasks}
      jobId={job.id}
      filesByTypeForItem={(task) => getFilesByTypeForTask(task, job.id)}
    />
  );
}
```

### Custom File Handling

```javascript
function CustomFilePane({ jobId, taskId, type, filename }) {
  const [content, setContent] = useState(null);

  useEffect(() => {
    fetch(
      `/api/jobs/${jobId}/tasks/${taskId}/file?type=${type}&filename=${filename}`
    )
      .then((res) => res.json())
      .then((data) => setContent(data.content));
  }, [jobId, taskId, type, filename]);

  return <div>{content}</div>;
}
```

## Troubleshooting

### Common Issues

1. **Files not showing**: Check if `filesByTypeForItem` returns correct data
2. **Preview not loading**: Verify API endpoints and network connectivity
3. **Styling issues**: Ensure Tailwind CSS is properly configured
4. **Keyboard navigation**: Check for missing `tabIndex` or event handlers

### Debug Tips

- Use browser dev tools to inspect API requests
- Check console for error messages
- Verify file permissions and server configuration
- Test with different file types and categories
